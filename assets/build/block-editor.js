(()=>{"use strict";const e=window.React,t="wp_translation_selected_backend",n={getSelectedBackend(){if(window.translationSelectedBackend)return window.translationSelectedBackend;const e=localStorage.getItem(t);if(e)return e;const n=window.translationConfig?.backends||{};return Object.keys(n)[0]||"google"},setSelectedBackend(e){window.translationSelectedBackend=e,localStorage.setItem(t,e),window.dispatchEvent(new CustomEvent("translationBackendChanged",{detail:{backend:e}}))},getBackendName:e=>(window.translationConfig?.backends||{})[e]||e,onBackendChange(e){const t=t=>e(t.detail.backend);return window.addEventListener("translationBackendChanged",t),()=>window.removeEventListener("translationBackendChanged",t)}},{__}=wp.i18n,{Dropdown:a,MenuGroup:o,MenuItem:r}=wp.components,l=({languages:t,onSelect:n,renderToggle:l,headerText:c,infoText:s,showBackendInfo:i=!1,backendName:d="",className:p="translation-language-dropdown"})=>(0,e.createElement)(a,{className:p,popoverProps:{placement:"bottom-start"},contentClassName:"translation-dropdown-content",renderToggle:l,renderContent:({onClose:a})=>(0,e.createElement)("div",{style:{minWidth:"200px"}},(c||i)&&(0,e.createElement)("div",{style:{padding:"8px 12px",borderBottom:"1px solid #ddd",fontSize:"11px",color:"#666",background:"#f9f9f9"}},c&&(0,e.createElement)("div",{style:{fontWeight:"600",marginBottom:"2px"}},c),i&&d&&(0,e.createElement)("div",null,__("Using:","wordpress-openai-translation")," ",(0,e.createElement)("strong",null,d))),s&&(0,e.createElement)("div",{style:{padding:"8px 12px",fontSize:"11px",color:"#666",background:"#f0f6fc",borderBottom:"1px solid #ddd"}},s),(0,e.createElement)(o,{label:c||s?void 0:__("Select Language","wordpress-openai-translation")},t.map(t=>(0,e.createElement)(r,{key:t.code,onClick:()=>{n(t.code),a()},icon:"translation",iconPosition:"left"},t.label))))}),{__:c}=wp.i18n,s=wp.apiFetch,{__:i}=wp.i18n,{useState:d,useEffect:p}=wp.element,{BlockControls:w}=wp.blockEditor,{ToolbarGroup:m,ToolbarButton:u,Spinner:k}=wp.components,{useDispatch:g}=wp.data,b=({clientId:t,attributes:a,name:o})=>{const[r,c]=d(!1),[b,B]=d(""),{updateBlockAttributes:f}=g("core/block-editor");if(!["core/paragraph","core/heading","core/list","core/quote"].includes(o))return null;p(()=>{const e=n.getSelectedBackend();return B(e),n.onBackendChange(e=>{B(e)})},[]);const h=window.translationConfig?.languages||[],E=window.translationConfig?.restNamespace||"wp-translation/v1",y=async(e,l=b)=>{if(!r){c(!0);try{const r=a.content||"",c={name:o,attributes:{...a}},i=await(async({backend:e,block:t,language:n,restNamespace:a})=>{const o=await s({path:`/${a}/translate-block-${e}`,method:"POST",data:{block:t,language:n}});if(o.error)throw new Error(o.error);return o})({backend:l,block:c,language:e,restNamespace:E});f(t,{content:i.translatedContent,_translationBackup:{content:r,timestamp:Date.now(),language:e,backend:l,backendName:n.getBackendName(l)},_individuallyTranslated:{timestamp:Date.now(),language:e,backend:l}})}catch(e){console.error("Block translation failed:",e),alert(e.message||i("Translation failed","wordpress-openai-translation"))}finally{c(!1)}}};window.translateBlockAsync=window.translateBlockAsync||{},window.translateBlockAsync[t]=(e,t)=>y(e,t);const S=n.getBackendName(b),C=r?i("Translating Block...","wordpress-openai-translation"):i("Translate Block","wordpress-openai-translation")+" ("+S+")";return(0,e.createElement)(w,null,(0,e.createElement)(m,null,(0,e.createElement)(l,{languages:h,onSelect:e=>y(e,b),headerText:i("Block Translation","wordpress-openai-translation"),showBackendInfo:!0,backendName:S,renderToggle:({isOpen:t,onToggle:n})=>(0,e.createElement)(u,{icon:r?void 0:"translation",label:C,onClick:n,"aria-expanded":t,disabled:r,style:{color:r?"#666":"#2271b1"}},r&&(0,e.createElement)(k,{style:{margin:0}}))})))},{__:B}=wp.i18n,{BlockControls:f}=wp.blockEditor,{ToolbarGroup:h,ToolbarButton:E}=wp.components,{useDispatch:y}=wp.data,S=({clientId:t,attributes:n})=>{const{updateBlockAttributes:a}=y("core/block-editor");if(void 0===n._translationBackup)return null;const o=n._translationBackup,r=o.backendName||o.backend||"",l=o.timestamp?new Date(o.timestamp).toLocaleString():"";let c=B("Restore Original","wordpress-openai-translation");return r&&(c+=" ("+r,l&&(c+=", "+l),c+=")"),(0,e.createElement)(f,null,(0,e.createElement)(h,null,(0,e.createElement)(E,{icon:"undo",label:c,onClick:()=>{const e=n._translationBackup,o=e.backendName||e.backend||"Unknown",r=e.timestamp?new Date(e.timestamp).toLocaleString():"";let l=B("Restore original content?","wordpress-openai-translation");l+="\n\n",l+=B("Translation by:","wordpress-openai-translation")+" "+o,r&&(l+="\n"+B("Date:","wordpress-openai-translation")+" "+r),confirm(l)&&a(t,{content:e.content,_translationBackup:void 0})},className:"block-rollback-button",style:{color:"#d94f4f"}})))},{__:C}=wp.i18n,{useState:v,useEffect:T}=wp.element,{useSelect:_,useDispatch:N}=wp.data,{Button:x,Spinner:I}=wp.components,D=()=>{const[e,t]=v(!1),[n,a]=v(new Set),[o,r]=v({current:0,total:0}),{selectedBlocks:l,hasSelection:c}=_(e=>{const t=e("core/block-editor").getMultiSelectedBlockClientIds();return{selectedBlocks:t.map(t=>({clientId:t,...e("core/block-editor").getBlock(t)})),hasSelection:t.length>1}},[]),s=async(n,o)=>{if(e||0===l.length)return;const c=["core/paragraph","core/heading","core/list","core/quote"],s=l.filter(e=>c.includes(e.name));if(0===s.length)return void alert(C("No translatable blocks selected","wordpress-openai-translation"));t(!0),r({current:0,total:s.length});const i=s.map(async(e,t)=>{const{clientId:l}=e;a(e=>new Set([...e,l]));try{window.translateBlockAsync&&window.translateBlockAsync[l]&&await window.translateBlockAsync[l](n,o)}catch(e){console.error(`Failed to translate block ${l}:`,e)}finally{r(e=>({...e,current:e.current+1})),a(e=>{const t=new Set(e);return t.delete(l),t})}});await Promise.all(i),t(!1),r({current:0,total:0})};return T(()=>{window.batchTranslateBlocks=s},[l,e]),null},{addFilter:A}=wp.hooks,{createHigherOrderComponent:L}=wp.compose,{Fragment:O}=wp.element;A("editor.BlockEdit","wordpress-openai-translation/block-controls",L(t=>n=>{const{clientId:a,attributes:o,name:r}=n;return(0,e.createElement)(O,null,(0,e.createElement)(b,{clientId:a,attributes:o,name:r}),(0,e.createElement)(S,{clientId:a,attributes:o}),(0,e.createElement)(t,{...n}))},"withTranslationControls")),document.addEventListener("DOMContentLoaded",()=>{const{render:e}=wp.element,t=document.createElement("div");t.style.display="none",document.body.appendChild(t),e(wp.element.createElement(D),t)})})();