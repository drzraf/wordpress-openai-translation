(()=>{"use strict";const e=window.React,t="wp_translation_selected_backend",n={getSelectedBackend(){if(window.translationSelectedBackend)return window.translationSelectedBackend;const e=localStorage.getItem(t);if(e)return e;const n=window.translationConfig?.backends||{};return Object.keys(n)[0]||"google"},setSelectedBackend(e){window.translationSelectedBackend=e,localStorage.setItem(t,e),window.dispatchEvent(new CustomEvent("translationBackendChanged",{detail:{backend:e}}))},getBackendName:e=>(window.translationConfig?.backends||{})[e]||e,onBackendChange(e){const t=t=>e(t.detail.backend);return window.addEventListener("translationBackendChanged",t),()=>window.removeEventListener("translationBackendChanged",t)}},{__}=wp.i18n,{Dropdown:a,MenuGroup:o,MenuItem:l}=wp.components,r=({languages:t,onSelect:n,renderToggle:r,headerText:c,infoText:s,showBackendInfo:i=!1,backendName:d="",className:p="translation-language-dropdown"})=>(0,e.createElement)(a,{className:p,popoverProps:{placement:"bottom-start"},contentClassName:"translation-dropdown-content",renderToggle:r,renderContent:({onClose:a})=>(0,e.createElement)("div",{style:{minWidth:"200px"}},(c||i)&&(0,e.createElement)("div",{style:{padding:"8px 12px",borderBottom:"1px solid #ddd",fontSize:"11px",color:"#666",background:"#f9f9f9"}},c&&(0,e.createElement)("div",{style:{fontWeight:"600",marginBottom:"2px"}},c),i&&d&&(0,e.createElement)("div",null,__("Using:","wordpress-openai-translation")," ",(0,e.createElement)("strong",null,d))),s&&(0,e.createElement)("div",{style:{padding:"8px 12px",fontSize:"11px",color:"#666",background:"#f0f6fc",borderBottom:"1px solid #ddd"}},s),(0,e.createElement)(o,{label:c||s?void 0:__("Select Language","wordpress-openai-translation")},t.map(t=>(0,e.createElement)(l,{key:t.code,onClick:()=>{n(t.code),a()},icon:"translation",iconPosition:"left"},t.label))))}),{__:c}=wp.i18n,s=wp.apiFetch,i=(e,t)=>{e.attributes&&t(e.clientId,e.attributes),e.innerBlocks&&e.innerBlocks.length>0&&e.innerBlocks.forEach(e=>{i(e,t)})},{registerBlockType:d}=wp.blocks||{},p=()=>(0,e.createElement)("svg",{viewBox:"0 0 20 20",xmlns:"http://www.w3.org/2000/svg"},(0,e.createElement)("rect",{x:"0",fill:"none",width:"20",height:"20"}),(0,e.createElement)("g",null,(0,e.createElement)("path",{d:"M11 7H9.49c-.63 0-1.25.3-1.59.7L7 5H4.13l-2.39 7h1.69l.74-2H7v4H2c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h7c1.1 0 2 .9 2 2v2zM6.51 9H4.49l1-2.93zM10 8h7c1.1 0 2 .9 2 2v7c0 1.1-.9 2-2 2h-7c-1.1 0-2-.9-2-2v-7c0-1.1.9-2 2-2zm7.25 5v-1.08h-3.17V9.75h-1.16v2.17H9.75V13h1.28c.11.85.56 1.85 1.28 2.62-.87.36-1.89.62-2.31.62-.01.02.22.97.2 1.46.84 0 2.21-.5 3.28-1.15 1.09.65 2.48 1.15 3.34 1.15-.02-.49.2-1.44.2-1.46-.43 0-1.49-.27-2.38-.63.7-.77 1.14-1.77 1.25-2.61h1.36zm-3.81 1.93c-.5-.46-.85-1.13-1.01-1.93h2.09c-.17.8-.51 1.47-1 1.93l-.04.03s-.03-.02-.04-.03z"})),(0,e.createElement)("g",{transform:"matrix(0.49483711,0,0,0.49483711,8.6842548,-0.80509127)"},(0,e.createElement)("path",{d:"M 12,5 H 7 V 2 L 1,6 7,10 V 7 h 5 c 2.2,0 4,1.8 4,4 0,2.2 -1.8,4 -4,4 H 7 v 2 h 5 c 3.3,0 6,-2.7 6,-6 0,-3.3 -2.7,-6 -6,-6 z"}))),{serialize:m,parse:w}=wp.blocks,k=e=>e?._translationBackup||null,{__:u}=wp.i18n,{useState:g,useEffect:b}=wp.element,{BlockControls:B}=wp.blockEditor,{ToolbarGroup:h,ToolbarButton:f,Spinner:E}=wp.components,{useDispatch:v,useSelect:y}=wp.data,S=({clientId:t,attributes:a,name:o})=>{if(!(window.translationConfig?.supportedBlocks||[]).includes(o))return null;const[l,d]=g(!1),[S,C]=g(""),{updateBlockAttributes:T,replaceBlock:N}=v("core/block-editor"),x=y(e=>e("core/block-editor").getBlock(t),[t]),_=(e=>e&&void 0!==e._translationBackup)(a);b(()=>{const e=n.getSelectedBackend();return C(e),n.onBackendChange(e=>{C(e)})},[]);const I=window.translationConfig?.languages||[],z=window.translationConfig?.restNamespace||"wp-translation/v1",D=async(e,a=S)=>{if(!l){d(!0);try{const o=n.getBackendName(a),l=((e,t={})=>({serialized:m(e),timestamp:Date.now(),...t}))(x,{language:e,backend:a,backendName:o}),r={clientId:x.clientId,name:x.name,attributes:{...x.attributes},innerBlocks:x.innerBlocks||[]},d=await(async({backend:e,block:t,language:n,restNamespace:a})=>{const o=await s({path:`/${a}/translate-${e}`,method:"POST",data:{title:"",blocks:[t],language:n}});if(o.errors){const e=Object.values(o.errors).join(", ");throw new Error(e)}const l=o.blocks?.[0];if(!l)throw new Error(c("No translated content returned","wordpress-openai-translation"));return{translatedBlock:l,blockType:t.name||""}})({backend:a,block:r,language:e,restNamespace:z}),p=d.translatedBlock,w=((e,t,n,a,o)=>{const l=e?._translationBackup;return{...e,_translationBackup:l||{...t,language:n,backend:a,backendName:o},_individuallyTranslated:{timestamp:Date.now(),language:n,backend:a}}})(p.attributes,l,e,a,o);T(t,w),p.innerBlocks&&p.innerBlocks.length>0&&p.innerBlocks.forEach(e=>{i(e,T)})}catch(e){console.error("Block translation failed:",e),alert(e.message||u("Translation failed","wordpress-openai-translation"))}finally{d(!1)}}},H=()=>{const e=k(a);if(!e)return void alert(u("No backup found","wordpress-openai-translation"));const n=e.backendName||e.backend||"Unknown",o=e.timestamp?new Date(e.timestamp).toLocaleString():"";let l=u("Restore original content?","wordpress-openai-translation");if(l+="\n\n",l+=u("Translation by:","wordpress-openai-translation")+" "+n,o&&(l+="\n"+u("Date:","wordpress-openai-translation")+" "+o),!confirm(l))return;const r=(e=>e&&e.serialized&&w(e.serialized)[0]||null)(e);r?N(t,r):alert(u("Unable to restore: backup format not recognized","wordpress-openai-translation"))};window.translateBlockAsync=window.translateBlockAsync||{},window.translateBlockAsync[t]=(e,t)=>D(e,t);const L=n.getBackendName(S);if(_){const t=k(a),n=t?.backendName||t?.backend||"",o=t?.timestamp?new Date(t.timestamp).toLocaleString():"";let l=u("Undo Translation","wordpress-openai-translation");return n&&(l+=" ("+n,o&&(l+=", "+o),l+=")"),(0,e.createElement)(B,null,(0,e.createElement)(h,null,(0,e.createElement)(f,{icon:(0,e.createElement)(p,null),label:l,onClick:H,className:"block-rollback-button",style:{color:"#d94f4f"}})))}{const t=l?u("Translating Block...","wordpress-openai-translation"):u("Translate Block","wordpress-openai-translation")+" ("+L+")";return(0,e.createElement)(B,null,(0,e.createElement)(h,null,(0,e.createElement)(r,{languages:I,onSelect:e=>D(e,S),headerText:u("Block Translation","wordpress-openai-translation"),showBackendInfo:!0,backendName:L,renderToggle:({isOpen:n,onToggle:a})=>(0,e.createElement)(f,{icon:l?void 0:"translation",label:t,onClick:a,"aria-expanded":n,disabled:l,style:{color:l?"#666":"#2271b1"}},l&&(0,e.createElement)(E,{style:{margin:0}}))})))}},{__:C}=wp.i18n,{useState:T,useEffect:N}=wp.element,{useSelect:x,useDispatch:_}=wp.data,{Button:I,Spinner:z}=wp.components,D=()=>{const[e,t]=T(!1),[n,a]=T(new Set),[o,l]=T({current:0,total:0}),{selectedBlocks:r,hasSelection:c}=x(e=>{const t=e("core/block-editor").getMultiSelectedBlockClientIds();return{selectedBlocks:t.map(t=>({clientId:t,...e("core/block-editor").getBlock(t)})),hasSelection:t.length>1}},[]),s=async(n,o)=>{if(e||0===r.length)return;const c=["core/paragraph","core/heading","core/list","core/quote"],s=r.filter(e=>c.includes(e.name));if(0===s.length)return void alert(C("No translatable blocks selected","wordpress-openai-translation"));t(!0),l({current:0,total:s.length});const i=s.map(async(e,t)=>{const{clientId:r}=e;a(e=>new Set([...e,r]));try{window.translateBlockAsync&&window.translateBlockAsync[r]&&await window.translateBlockAsync[r](n,o)}catch(e){console.error(`Failed to translate block ${r}:`,e)}finally{l(e=>({...e,current:e.current+1})),a(e=>{const t=new Set(e);return t.delete(r),t})}});await Promise.all(i),t(!1),l({current:0,total:0})};return N(()=>{window.batchTranslateBlocks=s},[r,e]),null},{addFilter:H}=wp.hooks,{createHigherOrderComponent:L}=wp.compose,{Fragment:M}=wp.element;H("editor.BlockEdit","wordpress-openai-translation/block-controls",L(t=>n=>{const{clientId:a,attributes:o,name:l}=n;return(0,e.createElement)(M,null,(0,e.createElement)(S,{clientId:a,attributes:o,name:l}),(0,e.createElement)(t,{...n}))},"withTranslationControls")),document.addEventListener("DOMContentLoaded",()=>{const{render:e}=wp.element,t=document.createElement("div");t.style.display="none",document.body.appendChild(t),e(wp.element.createElement(D),t)})})();
//# sourceMappingURL=block-editor.js.map