(()=>{"use strict";const e=window.React,t="wp_translation_selected_backend",n={getSelectedBackend(){if(window.translationSelectedBackend)return window.translationSelectedBackend;const e=localStorage.getItem(t);if(e)return e;const n=window.translationConfig?.backends||{};return Object.keys(n)[0]||"google"},setSelectedBackend(e){window.translationSelectedBackend=e,localStorage.setItem(t,e),window.dispatchEvent(new CustomEvent("translationBackendChanged",{detail:{backend:e}}))},getBackendName:e=>(window.translationConfig?.backends||{})[e]||e,onBackendChange(e){const t=t=>e(t.detail.backend);return window.addEventListener("translationBackendChanged",t),()=>window.removeEventListener("translationBackendChanged",t)}},{__}=wp.i18n,{Dropdown:a,MenuGroup:l,MenuItem:o}=wp.components,r=({languages:t,onSelect:n,renderToggle:r,headerText:i,infoText:s,showBackendInfo:d=!1,backendName:c="",className:p="translation-language-dropdown"})=>(0,e.createElement)(a,{className:p,popoverProps:{placement:"bottom-start"},contentClassName:"translation-dropdown-content",renderToggle:r,renderContent:({onClose:a})=>(0,e.createElement)("div",{style:{minWidth:"200px"}},(i||d)&&(0,e.createElement)("div",{style:{padding:"8px 12px",borderBottom:"1px solid #ddd",fontSize:"11px",color:"#666",background:"#f9f9f9"}},i&&(0,e.createElement)("div",{style:{fontWeight:"600",marginBottom:"2px"}},i),d&&c&&(0,e.createElement)("div",null,__("Using:","wordpress-openai-translation")," ",(0,e.createElement)("strong",null,c))),s&&(0,e.createElement)("div",{style:{padding:"8px 12px",fontSize:"11px",color:"#666",background:"#f0f6fc",borderBottom:"1px solid #ddd"}},s),(0,e.createElement)(l,{label:i||s?void 0:__("Select Language","wordpress-openai-translation")},t.map(t=>(0,e.createElement)(o,{key:t.code,onClick:()=>{n(t.code),a()},icon:"translation",iconPosition:"left"},t.label))))}),{__:i}=wp.i18n,s=wp.apiFetch,d=(e,t)=>{e.attributes&&t(e.clientId,e.attributes),e.innerBlocks&&e.innerBlocks.length>0&&e.innerBlocks.forEach(e=>{d(e,t)})},c=e=>e.map(e=>{if(e.attributes._individuallyTranslated)return null;if(e.innerBlocks&&e.innerBlocks.length>0){const t=c(e.innerBlocks).filter(e=>null!==e);return 0===t.length&&e.innerBlocks.length>0?null:{...e,innerBlocks:t}}return e}).filter(e=>null!==e),{__:p}=wp.i18n,{registerPlugin:g}=wp.plugins,{useState:u,useEffect:w}=wp.element,{PanelBody:m,PanelRow:k,Button:b,Spinner:E,SelectControl:f}=wp.components,{PluginSidebar:v}=wp.editPost,{useSelect:h,useDispatch:y}=wp.data,B=()=>{const[t,a]=u(!1),[l,o]=u(!1),[i,g]=u(""),[v,B]=u({}),[S,T]=u([]);w(()=>{if(window.translationConfig){const e=window.translationConfig.backends||{};B(e);const t=n.getSelectedBackend();g(t),T(window.translationConfig.languages||[])}},[]);const{title:x,blocks:C}=h(e=>({title:e("core/editor").getEditedPostAttribute("title"),blocks:e("core/block-editor").getBlocks()}),[]),P=y(),{editPost:_}=y("core/editor"),{updateBlockAttributes:N}=y("core/block-editor"),A=window.translationConfig?.restNamespace||"wp-translation/v1",O=async(e,t)=>{if(!i)return void alert(p("No translation backend selected","wordpress-openai-translation"));const n="title"===t,l="all"===t,r=n?o:a;r(!0);try{await(async t=>{const{lockPostSaving:a,unlockPostSaving:o,lockPostAutosaving:r,unlockPostAutosaving:g}=t("core/editor");a("translation-in-progress"),r("translation-in-progress");try{return await(async()=>{let t;if(n)t=[];else if(l)t=C;else if(t=c(C),0===t.length)return void alert(p('All blocks have been individually translated. Use "Re-translate All" to override.',"wordpress-openai-translation"));const a=await(async({backend:e,title:t,blocks:n,language:a,restNamespace:l})=>{const o=await s({path:`/${l}/translate-${e}`,method:"POST",data:{title:t,blocks:n,language:a}});if(o.errors){const e=Object.values(o.errors).join(", ");throw new Error(e)}return o})({backend:i,title:x,blocks:t,language:e,restNamespace:A});_({title:a.title}),n||a.blocks.forEach(e=>{d(e,N)})})()}finally{o("translation-in-progress"),g("translation-in-progress")}})(P)}catch(e){alert(e.message||p("Translation failed","wordpress-openai-translation"))}finally{r(!1)}},I=Object.keys(v),j=I.length>1,z=t||l||!i;return(0,e.createElement)(m,{title:p("Translation","wordpress-openai-translation")},j&&(0,e.createElement)(k,null,(0,e.createElement)(f,{label:p("Translation Backend","wordpress-openai-translation"),value:i,options:[{value:"",label:p("Select backend...","wordpress-openai-translation"),disabled:!0},...I.map(e=>({value:e,label:v[e]}))],onChange:e=>{g(e),n.setSelectedBackend(e)},disabled:z})),(0,e.createElement)(k,null,(0,e.createElement)("div",{style:{width:"100%"}},(0,e.createElement)("div",{style:{marginBottom:"8px",fontSize:"11px",color:"#757575"}},i&&v[i]&&(0,e.createElement)("span",null,p("Using:","wordpress-openai-translation")," ",(0,e.createElement)("strong",null,v[i]))),(0,e.createElement)(r,{languages:S,onSelect:e=>O(e,"untranslated"),infoText:p("Translate remaining untranslated blocks","wordpress-openai-translation"),renderToggle:({isOpen:n,onToggle:a})=>(0,e.createElement)(b,{onClick:a,"aria-expanded":n,disabled:z,variant:"secondary",style:{width:"100%"}},t?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(E,null),p("Translating...","wordpress-openai-translation")):p("Translate page","wordpress-openai-translation"))}))),(0,e.createElement)(k,null,(0,e.createElement)("div",{style:{width:"100%"}},(0,e.createElement)(r,{languages:S,onSelect:e=>O(e,"all"),infoText:p("Translates all blocks, including previously translated","wordpress-openai-translation"),renderToggle:({isOpen:t,onToggle:n})=>(0,e.createElement)(b,{onClick:n,"aria-expanded":t,disabled:z,variant:"secondary",style:{width:"100%"},isDestructive:!0},p("Re-translate All","wordpress-openai-translation"))}))),(0,e.createElement)(k,null,(0,e.createElement)("div",{style:{width:"100%"}},(0,e.createElement)("div",{style:{marginBottom:"8px",fontSize:"11px",color:"#757575",fontWeight:"600"}},p("Translate Title Only","wordpress-openai-translation")),(0,e.createElement)(r,{languages:S,onSelect:e=>O(e,"title"),renderToggle:({isOpen:t,onToggle:n})=>(0,e.createElement)(b,{onClick:n,"aria-expanded":t,disabled:z,variant:"secondary",style:{width:"100%"}},l?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(E,null),p("Translating title...","wordpress-openai-translation")):p("Translate title","wordpress-openai-translation"))}))))};g("openai-translation-plugin",{render:()=>(0,e.createElement)(v,{name:"openai-translation-sidebar",title:p("Automated translation","wordpress-openai-translation"),icon:"translation"},(0,e.createElement)(B,null))})})();