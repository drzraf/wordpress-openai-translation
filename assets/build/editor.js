(()=>{"use strict";const e=window.React,n="wp_translation_selected_backend",t={getSelectedBackend(){if(window.translationSelectedBackend)return window.translationSelectedBackend;const e=localStorage.getItem(n);if(e)return e;const t=window.translationConfig?.backends||{};return Object.keys(t)[0]||"google"},setSelectedBackend(e){window.translationSelectedBackend=e,localStorage.setItem(n,e),window.dispatchEvent(new CustomEvent("translationBackendChanged",{detail:{backend:e}}))},getBackendName:e=>(window.translationConfig?.backends||{})[e]||e,onBackendChange(e){const n=n=>e(n.detail.backend);return window.addEventListener("translationBackendChanged",n),()=>window.removeEventListener("translationBackendChanged",n)}},{__}=wp.i18n,{Dropdown:a,MenuGroup:l,MenuItem:o}=wp.components,r=({languages:n,onSelect:t,renderToggle:r,headerText:i,infoText:s,showBackendInfo:c=!1,backendName:d="",className:p="translation-language-dropdown"})=>(0,e.createElement)(a,{className:p,popoverProps:{placement:"bottom-start"},contentClassName:"translation-dropdown-content",renderToggle:r,renderContent:({onClose:a})=>(0,e.createElement)("div",{style:{minWidth:"200px"}},(i||c)&&(0,e.createElement)("div",{style:{padding:"8px 12px",borderBottom:"1px solid #ddd",fontSize:"11px",color:"#666",background:"#f9f9f9"}},i&&(0,e.createElement)("div",{style:{fontWeight:"600",marginBottom:"2px"}},i),c&&d&&(0,e.createElement)("div",null,__("Using:","wordpress-openai-translation")," ",(0,e.createElement)("strong",null,d))),s&&(0,e.createElement)("div",{style:{padding:"8px 12px",fontSize:"11px",color:"#666",background:"#f0f6fc",borderBottom:"1px solid #ddd"}},s),(0,e.createElement)(l,{label:i||s?void 0:__("Select Language","wordpress-openai-translation")},n.map(n=>(0,e.createElement)(o,{key:n.code,onClick:()=>{t(n.code),a()},icon:"translation",iconPosition:"left"},n.label))))}),{__:i}=wp.i18n,s=wp.apiFetch,c=(e,n)=>{e.attributes&&n(e.clientId,e.attributes),e.innerBlocks&&e.innerBlocks.length>0&&e.innerBlocks.forEach(e=>{c(e,n)})},d=e=>e.map(e=>{if(e.attributes._individuallyTranslated)return null;if(e.innerBlocks&&e.innerBlocks.length>0){const n=d(e.innerBlocks).filter(e=>null!==e);return 0===n.length&&e.innerBlocks.length>0?null:{...e,innerBlocks:n}}return e}).filter(e=>null!==e),{serialize:p,parse:g}=wp.blocks,{__:u}=wp.i18n,{registerPlugin:k}=wp.plugins,{useState:m,useEffect:w}=wp.element,{PanelBody:b,PanelRow:f,Button:B,Spinner:E,SelectControl:h}=wp.components,{PluginSidebar:v}=wp.editPost,{useSelect:y,useDispatch:S}=wp.data,T=()=>{const[n,a]=m(!1),[l,o]=m(!1),[i,g]=m(""),[k,v]=m({}),[T,x]=m([]);w(()=>{if(window.translationConfig){const e=window.translationConfig.backends||{};v(e);const n=t.getSelectedBackend();g(n),x(window.translationConfig.languages||[])}},[]);const{title:C,blocks:I}=y(e=>{const n=e("core/block-editor"),t=n.getClientIdsWithDescendants().map(e=>n.getBlock(e)).filter(e=>e&&!e.innerBlocks);return{title:e("core/editor").getEditedPostAttribute("title"),blocks:e("core/block-editor").getBlocks(),fullBlocks:t}},[]),P=S(),{editPost:_}=S("core/editor"),{updateBlockAttributes:N}=S("core/block-editor"),z=window.translationConfig?.restNamespace||"wp-translation/v1",A=async(e,n)=>{if(!i)return void alert(u("No translation backend selected","wordpress-openai-translation"));const l="title"===n,r="all"===n,g=l?o:a;g(!0);try{await(async n=>{const{lockPostSaving:a,unlockPostSaving:o,lockPostAutosaving:g,unlockPostAutosaving:k}=n("core/editor");a("translation-in-progress"),g("translation-in-progress");try{return await(async()=>{const n=t.getBackendName(i);let a,o={};if(l)a=[];else if(r)a=I,I.forEach(e=>{const n=wp.data.select("core/block-editor").getBlock(e.clientId);if(n){const t=n.attributes?._translationBackup;if(t&&t.serialized){const a=wp.blocks.parse(t.serialized)[0];o[e.clientId]=a||n}else o[e.clientId]=n}});else{if(a=d(I),0===a.length)return void alert(u('All blocks have been individually translated. Use "Re-translate All" to override.',"wordpress-openai-translation"));a.forEach(e=>{const n=wp.data.select("core/block-editor").getBlock(e.clientId);n&&(o[e.clientId]=n)})}const g=await(async({backend:e,title:n,blocks:t,language:a,restNamespace:l})=>{const o=await s({path:`/${l}/translate-${e}`,method:"POST",data:{title:n,blocks:t,language:a}});if(o.errors){const e=Object.values(o.errors).join(", ");throw new Error(e)}return o})({backend:i,title:C,blocks:a,language:e,restNamespace:z});if(_({title:g.title}),!l){const t=window.translationConfig?.supportedBlocks||[],a=["core/group","core/columns","core/column","core/cover","core/media-text","core/row","core/stack","core/buttons"],l=(o,r)=>{if(t.includes(o.name)&&!a.includes(o.name)){const t=((e,n={})=>({serialized:p(e),timestamp:Date.now(),...n}))(o,{language:e,backend:i,backendName:n});r.attributes=((e,n,t,a,l)=>{const o=e?._translationBackup;return{...e,_translationBackup:o||{...n,language:t,backend:a,backendName:l},_individuallyTranslated:{timestamp:Date.now(),language:t,backend:a}}})(r.attributes,t,e,i,n)}if(o.innerBlocks&&o.innerBlocks.length>0&&r.innerBlocks&&r.innerBlocks.length>0){const e={};o.innerBlocks.forEach(n=>{e[n.clientId]=n}),r.innerBlocks.forEach(n=>{const t=e[n.clientId];t?l(t,n):console.warn("No original block found for clientId:",n.clientId)})}};g.blocks.forEach(e=>{const n=o[e.clientId];n&&l(n,e),c(e,N)})}})()}finally{o("translation-in-progress"),k("translation-in-progress")}})(P)}catch(e){alert(e.message||u("Translation failed","wordpress-openai-translation"))}finally{g(!1)}},O=Object.keys(k),D=O.length>1,j=n||l||!i;return(0,e.createElement)(b,{title:u("Translation","wordpress-openai-translation")},D&&(0,e.createElement)(f,null,(0,e.createElement)(h,{label:u("Translation Backend","wordpress-openai-translation"),value:i,options:[{value:"",label:u("Select backend...","wordpress-openai-translation"),disabled:!0},...O.map(e=>({value:e,label:k[e]}))],onChange:e=>{g(e),t.setSelectedBackend(e)},disabled:j})),(0,e.createElement)(f,null,(0,e.createElement)("div",{style:{width:"100%"}},(0,e.createElement)("div",{style:{marginBottom:"8px",fontSize:"11px",color:"#757575"}},i&&k[i]&&(0,e.createElement)("span",null,u("Using:","wordpress-openai-translation")," ",(0,e.createElement)("strong",null,k[i]))),(0,e.createElement)(r,{languages:T,onSelect:e=>A(e,"untranslated"),infoText:u("Translate remaining untranslated blocks","wordpress-openai-translation"),renderToggle:({isOpen:t,onToggle:a})=>(0,e.createElement)(B,{onClick:a,"aria-expanded":t,disabled:j,variant:"secondary",style:{width:"100%"}},n?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(E,null),u("Translating...","wordpress-openai-translation")):u("Translate page","wordpress-openai-translation"))}))),(0,e.createElement)(f,null,(0,e.createElement)("div",{style:{width:"100%"}},(0,e.createElement)(r,{languages:T,onSelect:e=>A(e,"all"),infoText:u("Translates all blocks, including previously translated","wordpress-openai-translation"),renderToggle:({isOpen:n,onToggle:t})=>(0,e.createElement)(B,{onClick:t,"aria-expanded":n,disabled:j,variant:"secondary",style:{width:"100%"},isDestructive:!0},u("Re-translate All","wordpress-openai-translation"))}))),(0,e.createElement)(f,null,(0,e.createElement)("div",{style:{width:"100%"}},(0,e.createElement)("div",{style:{marginBottom:"8px",fontSize:"11px",color:"#757575",fontWeight:"600"}},u("Translate Title Only","wordpress-openai-translation")),(0,e.createElement)(r,{languages:T,onSelect:e=>A(e,"title"),renderToggle:({isOpen:n,onToggle:t})=>(0,e.createElement)(B,{onClick:t,"aria-expanded":n,disabled:j,variant:"secondary",style:{width:"100%"}},l?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(E,null),u("Translating title...","wordpress-openai-translation")):u("Translate title","wordpress-openai-translation"))}))))};k("openai-translation-plugin",{render:()=>(0,e.createElement)(v,{name:"openai-translation-sidebar",title:u("Automated translation","wordpress-openai-translation"),icon:"translation"},(0,e.createElement)(T,null))})})();
//# sourceMappingURL=editor.js.map